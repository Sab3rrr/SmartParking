# 停车场管理系统收费规则及类说明文档

## 一、收费规则说明

### 一、文档说明
- 设计对象：停车场管理系统中的计时收费模型及核心业务类
- 设计目标：定义系统中停车费用计算规则、核心业务类的结构及类间关系，为停车收费功能提供规范的实现依据
- 技术栈：Python、tkinter（界面）、datetime（时间处理）、数据库操作模块
- 设计原则：
  - 采用模块化设计，分离界面层、数据处理层和数据存储层
  - 费用计算逻辑独立封装，确保可扩展性和可维护性
  - 所有时间处理采用统一格式（YYYY-MM-DD HH:MM:SS），保证数据一致性
  - 针对不同用户类型（居民/访客）设计差异化的收费结算流程
- 计费核心原则：
  - 基础计费单位为小时，采用向上取整方式计算时长（不足1小时按1小时计费）
  - 费率可通过配置参数灵活调整，默认基础费率为5.0元/小时
  - 费用计算基于进场时间与出场时间的差值，支持实时费用预估
- 设计时间：2025年11月1日
- 设计人员：蔡右俊

## 二、类结构说明

### 1. `UserWindow`类（位于`ui_user.py`）

#### 类功能描述
实现停车场管理系统的用户端界面，支持居民和访客两种操作模式，提供进场登记、离场结算、费用查询等核心功能。

#### 主要属性
| 属性名 | 类型 | 说明 |
|--------|------|------|
| `root` | `tk.Tk`/`tk.Toplevel` | 界面根窗口 |
| `resident_info` | `Dict`/`None` | 居民信息字典（访客模式为None） |
| `login_window` | 窗口对象 | 登录窗口引用，用于退出登录时返回 |
| `is_resident` | `bool` | 是否为居民模式（True为居民，False为访客） |
| `style` | `ttk.Style` | 界面样式配置 |
| `info_text` | `tk.Text` | 信息显示区域控件 |
| `visitor_plate_var` | `tk.StringVar` | 访客模式下车牌号输入变量（仅访客模式使用） |

#### 主要方法
| 方法名 | 功能描述 |
|--------|----------|
| `__init__` | 初始化窗口，设置标题、大小和样式 |
| `_center_window` | 使窗口在屏幕居中显示 |
| `_create_widgets` | 创建界面所有控件 |
| `_append_info` | 向信息显示区域添加文本 |
| `_entry_register` | 处理车辆进场登记逻辑 |
| `_exit_settlement` | 处理车辆离场结算及费用支付 |
| `_query_current_fee` | 查询当前停车费用 |
| `_recharge` | 居民用户余额充值功能（仅居民模式） |
| `_view_records` | 查看停车记录（仅居民模式） |
| `_refresh_resident_info` | 刷新居民信息显示 |
| `_logout` | 处理退出登录逻辑 |
| `_on_close` | 窗口关闭事件处理 |

## 三、类关系说明

### 1. `UserWindow`与数据库操作模块（`db.py`）的关系
- `UserWindow`通过调用`db.py`中的函数实现数据持久化操作
- 主要调用的函数包括：
  - `get_active_parking_record`：获取当前有效的停车记录
  - `create_parking_record`：创建新的停车记录
  - `close_parking_record`：结算并关闭停车记录
  - `update_resident_balance`：更新居民账户余额
  - `get_resident_by_phone`：获取居民信息
  - `get_parking_records`：查询停车记录历史

### 2. `UserWindow`与工具函数模块（`utils.py`）的关系
- `UserWindow`依赖`utils.py`中的工具函数处理时间和费用计算
- 主要调用的函数包括：
  - `calc_fee`：计算停车费用
  - `now_str`：获取当前时间字符串
  - `format_balance`：格式化余额显示
  - `format_datetime_for_display`：格式化日期时间显示
  - `calculate_duration`：计算并格式化停车时长

### 3. `UserWindow`与登录窗口的关系
- `UserWindow`持有登录窗口的引用（`login_window`属性）
- 当用户退出登录或关闭窗口时，通过该引用恢复显示登录窗口

### 4. 交互流程关系
- 居民/访客通过`UserWindow`界面发起操作（进场、离场等）
- 界面层调用工具函数进行数据处理（费用计算、时间格式化等）
- 界面层调用数据库模块进行数据存储与查询
- 操作结果通过`_append_info`方法反馈到界面显示区域